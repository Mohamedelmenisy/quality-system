<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quality Command Center | QualityX</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%2300bfff'/><text x='50' y='55' font-family='Poppins, sans-serif' font-size='60' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='middle'>Q</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #00bfff;
            --primary-color-darker: #007BFF;
            --bg-color: #121212;
            --sidebar-bg: #1a1a1a;
            --card-bg: #1a1a1a;
            --text-color: #e6edf3;
            --text-muted-color: #8b949e;
            --border-color: #333;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --font-body: 'Poppins', sans-serif;
            --border-radius-base: 0.75rem;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-body); background-color: var(--bg-color); color: var(--text-color); font-size: 16px; }
        .layout { display: flex; min-height: 100vh; }
        .sidebar {
            width: 250px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; padding: 1.5rem 0; position: fixed; height: 100%; z-index: 1000;
            transition: width 0.3s ease;
        }
        .sidebar-header {
            padding: 0 1.5rem 1.5rem 1.5rem; display: flex; align-items: center; gap: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        .sidebar-logo { height: 32px; fill: var(--primary-color); }
        .sidebar-title { font-size: 1.25rem; color: var(--primary-color); font-weight: 700; }
        .sidebar-nav-container { flex-grow: 1; overflow-y: auto; padding-top: 1rem; }
        .nav-group { margin-bottom: 1.5rem; padding: 0 1.5rem; }
        .nav-group-title {
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;
            color: var(--text-muted-color); font-weight: 600; margin-bottom: 0.75rem;
        }
        .sidebar-nav { list-style: none; }
        .sidebar-nav a {
            display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1rem; margin: 0.25rem 0;
            text-decoration: none; color: var(--text-muted-color); font-weight: 500; border-radius: 0.5rem;
            transition: all 0.2s ease; cursor: pointer;
        }
        .sidebar-nav a:hover { background-color: rgba(0, 191, 255, 0.1); color: var(--primary-color); }
        .sidebar-nav li.active a { background-color: var(--primary-color); color: black; font-weight: 600; }
        .sidebar-footer { padding: 1.5rem; border-top: 1px solid var(--border-color); }
        .user-profile-widget { display: flex; align-items: center; gap: 12px; }
        .avatar-initials {
            width: 44px; height: 44px; border-radius: 50%; background-color: var(--primary-color);
            color: black; font-weight: 700; font-size: 1rem;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .user-info .user-name { font-weight: 600; font-size: 1rem; }
        .user-info .user-role { font-size: 0.8rem; color: var(--text-muted-color); }
        .user-status { font-size: 0.75rem; color: var(--success-color); margin-top: 2px; }

        .main-wrapper { flex-grow: 1; margin-left: 250px; display: flex; flex-direction: column; transition: margin-left 0.3s ease; }
        .topbar {
            background-color: var(--sidebar-bg); border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 900;
        }
        .page-title { font-size: 1.5rem; color: var(--text-color); font-weight: 700; }
        .topbar-actions { display: flex; align-items: center; gap: 1rem; }
        .notification-bell { position: relative; }
        .notification-btn { background: none; border: none; color: var(--text-muted-color); font-size: 22px; cursor: pointer; }
        .main-content { padding: 2rem; flex-grow: 1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;}
        .kpi-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius-base); padding: 1.5rem; }
        .kpi-card .kpi-title { font-size: 0.9rem; color: var(--text-muted-color); margin-bottom: 0.5rem; }
        .kpi-card .kpi-value { font-size: 2rem; font-weight: 700; color: var(--text-color); }
        .kpi-card .kpi-change { font-size: 0.9rem; font-weight: 500; margin-top: 0.25rem; }
        .widget { background-color: var(--card-bg); border-radius: var(--border-radius-base); padding: 1.5rem; border: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        .widget h3 { font-size: 1.25rem; margin-bottom: 1rem; color: var(--text-color); font-weight: 700; }
        
        .results-table-container { overflow-x: auto; }
        .results-table { width: 100%; border-collapse: collapse; }
        .results-table thead th { padding: 1rem 1.5rem; text-align: left; background-color: #2c2c2c; font-size: 0.8rem; text-transform: uppercase; color: var(--text-muted-color); font-weight: 600; }
        .results-table tbody td { padding: 1rem 1.5rem; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle;}
        .status-badge { padding: 0.3em 0.7em; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-align: center; display: inline-block; text-transform: capitalize; }
        .status-pending { background-color: var(--info-color); color: white; }
        .status-in_progress { background-color: var(--primary-color); color: black; }
        .status-completed { background-color: var(--success-color); color: white; }
        .status-escalated { background-color: var(--warning-color); color: black; }
        .status-error { background-color: var(--danger-color); color: white; }
        
        .filter-bar { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; margin-bottom: 1.5rem; }
        .filter-bar .filter-group { display: flex; align-items: center; gap: 0.5rem;}
        .filter-bar label { font-size: 0.9rem; font-weight: 500; color: var(--text-muted-color); }
        .filter-bar select, .filter-bar input { background: #2c2c2c; border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); padding: 8px 12px; }
        
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 600; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;}
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary-color); color: black; }
        .btn-secondary { background-color: #333; color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1001; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-overlay.show { display: flex; animation: fadeIn 0.3s ease; }
        .modal-box { background: var(--card-bg); padding: 2rem; border-radius: var(--border-radius-base); border: 1px solid var(--border-color); width: 90%; max-width: 800px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem; }
        .modal-title { font-size: 1.25rem; font-weight: 700; }
        .modal-close-btn { background: none; border: none; color: var(--text-muted-color); font-size: 1.5rem; cursor: pointer; }
        .modal-body .form-group { margin-bottom: 1rem; }
        .modal-body label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .modal-body textarea, .modal-body select, .modal-body input { width: 100%; background: #2c2c2c; border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); padding: 8px 12px; font-family: inherit; resize: vertical;}
        .modal-footer { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }

        .team-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .team-member-card { background-color: #222; border: 1px solid var(--border-color); border-radius: var(--border-radius-base); padding: 1.5rem; text-align: center; }
        .team-member-avatar-initials { width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 700; color: black; }
        .team-member-name { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.25rem; }
        .team-member-role { color: var(--primary-color); font-size: 0.9rem; font-weight: 500; }

        .pagination-controls { display: flex; justify-content: flex-end; align-items: center; gap: 1rem; margin-top: 1.5rem; }
        .placeholder { text-align: center; padding: 3rem; color: var(--text-muted-color); border: 2px dashed var(--border-color); border-radius: var(--border-radius-base); }
        
        #toast-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; opacity: 0; transform: translateY(20px); transition: all 0.3s ease; font-weight: 500; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast-success { background-color: var(--success-color); }
        .toast-error { background-color: var(--danger-color); }
        .toast-info { background-color: var(--info-color); }

        .footer { padding: 1.5rem 2rem; text-align: center; color: var(--text-muted-color); border-top: 1px solid var(--border-color); margin-top: auto; }

        @media (max-width: 992px) {
            .sidebar { width: 70px; }
            .sidebar .sidebar-title, .sidebar .nav-group-title, .sidebar .user-info, .sidebar-nav a span { display: none; }
            .sidebar-nav a { justify-content: center; }
            .main-wrapper { margin-left: 70px; }
            .topbar { flex-direction: column; align-items: flex-start; gap: 1rem; }
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div class="layout">
        <aside class="sidebar" id="sidebar">
            <div>
                <div class="sidebar-header">
                    <svg class="sidebar-logo" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5-10-5-10 5z" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" fill-opacity="0.3"></path><path d="M12 22V12" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    <h1 class="sidebar-title">QualityX</h1>
                </div>

                <div class="sidebar-nav-container">
                    <div class="nav-group">
                        <h2 class="nav-group-title">Menu</h2>
                        <ul class="sidebar-nav">
                            <li class="active"><a data-tab="dashboard">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 15.2"/></svg>
                                <span>Dashboard</span></a></li>
                            <li><a data-tab="my-assigned-orders">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
                                <span>Assigned Orders</span></a></li>
                            <li><a data-tab="team-scheduling">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                <span>Team Scheduling</span></a></li>
                            <li><a data-tab="team-members">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                <span>Team Members</span></a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="user-profile-widget">
                    <div class="avatar-initials" id="sidebar-avatar-initials">...</div>
                    <div class="user-info">
                        <div class="user-name" id="sidebar-username">Loading...</div>
                        <div class="user-role" id="sidebar-userrole">Quality Agent</div>
                    </div>
                </div>
            </div>
        </aside>

        <div class="main-wrapper">
            <header class="topbar">
                 <h2 class="page-title" id="page-title">Dashboard</h2>
                <div class="topbar-actions">
                    <button id="new-review-btn" class="btn btn-primary">New Review</button>
                </div>
            </header>

            <main class="main-content">
                <!-- Dashboard -->
                <div id="dashboard" class="tab-content active">
                    <div id="welcome-message" style="margin-bottom: 1.5rem;">
                        <h2 style="font-size: 1.75rem; font-weight: 700;">Welcome, <span id="welcome-username">...</span>!</h2>
                        <p style="color: var(--text-muted-color);">Your central hub for monitoring quality and driving team excellence.</p>
                    </div>
                    <div class="kpi-grid">
                        <div class="kpi-card"><div class="kpi-title">Today's Reviews</div><div class="kpi-value" id="kpi-reviews">0</div></div>
                        <div class="kpi-card"><div class="kpi-title">Open Cases</div><div class="kpi-value" id="kpi-open-cases">0</div></div>
                        <div class="kpi-card"><div class="kpi-title">Avg. Quality Score</div><div class="kpi-value" id="kpi-quality-score">0%</div></div>
                        <div class="kpi-card"><div class="kpi-title">Escalation Rate</div><div class="kpi-value" id="kpi-escalation-rate">0%</div></div>
                    </div>
                    <div class="placeholder"><h3>Dashboard charts and recent activity will be implemented here.</h3></div>
                </div>
                
                <!-- Assigned Orders -->
                <div id="my-assigned-orders" class="tab-content">
                    <div class="widget">
                        <h3>Assigned Orders</h3>
                        <div class="filter-bar">
                             <div class="filter-group">
                                <input type="search" id="orders-search-input" placeholder="Search by Order ID..." class="form-control">
                            </div>
                            <div class="filter-group">
                                <label for="filter-status">Status:</label>
                                <select id="filter-status" class="form-control">
                                    <option value="all">All</option>
                                    <option value="pending">Pending</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="filter-issue-type">Issue Type:</label>
                                <select id="filter-issue-type" class="form-control">
                                    <option value="all">All Types</option>
                                </select>
                            </div>
                        </div>

                        <div class="results-table-container">
                            <table class="results-table">
                                <thead><tr><th>Order ID</th><th>Issue Type</th><th>Assigned On</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody id="orders-table-body"><tr_loading></tr></tbody>
                            </table>
                        </div>
                        <div class="pagination-controls">
                            <span id="pagination-info">Showing 0-0 of 0</span>
                            <div style="display: flex; gap: 0.5rem;">
                                <button id="prev-page-btn" class="btn btn-secondary" disabled>Previous</button>
                                <button id="next-page-btn" class="btn btn-secondary" disabled>Next</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Team Scheduling -->
                <div id="team-scheduling" class="tab-content">
                    <div class="widget">
                        <h3>Team Schedule</h3>
                        <div class="results-table-container">
                            <table class="results-table" id="schedule-table">
                                <!-- Schedule will be rendered by JS -->
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Team Members -->
                <div id="team-members" class="tab-content">
                    <div class="widget">
                        <h3>Team Members</h3>
                        <div class="team-grid" id="team-grid">
                            <!-- Team members will be rendered by JS -->
                        </div>
                    </div>
                </div>
                
                <!-- Other Placeholders -->
                <div id="reports" class="tab-content"><div class="placeholder"><h3>Reports & Analytics feature is under development.</h3></div></div>
                <div id="profile" class="tab-content"><div class="placeholder"><h3>Profile editing is under development.</h3></div></div>
                <div id="settings" class="tab-content"><div class="placeholder"><h3>Settings management is under development.</h3></div></div>
                <div id="help" class="tab-content"><div class="placeholder"><h3>Help Center is under development.</h3></div></div>
            </main>

            <footer class="footer">
                &copy; 2025 Mohamed Elmenisy. All rights reserved.
            </footer>
        </div>
    </div>
    
    <!-- Modals Container -->
    <div id="modals-container"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- API SERVICE (Mock Simulation) ---
        // This simulates talking to your Supabase backend.
        // Replace the logic inside these functions with actual `fetch` calls.
        const ApiService = {
            getCurrentUser: async () => {
                // SIMULATE API CALL
                return new Promise(resolve => setTimeout(() => resolve({
                    id: 'uuid-user-123',
                    name: 'Mohamed Elmenisy',
                    role: 'Quality Agent',
                    kpis: { reviews: 42, openCases: 6, qualityScore: 98.2, escalationRate: 2.1 }
                }), 500));
            },
            getAssignedOrders: async ({ page = 1, limit = 10, search = '', status = 'all' }) => {
                // SIMULATE API CALL
                console.log(`Fetching orders: page=${page}, search=${search}, status=${status}`);
                return new Promise(resolve => setTimeout(() => {
                    // This is fake data. In reality, this comes from your database.
                    const allOrders = [
                        { assignmentId: 'assign-1', orderId: 'CZ-84382', issueType: 'Missing Item', assignedOn: '2025-10-19T10:00:00Z', status: 'pending' },
                        { assignmentId: 'assign-2', orderId: 'CZ-84381', issueType: 'Wrong Item', assignedOn: '2025-10-19T09:30:00Z', status: 'in_progress' },
                        { assignmentId: 'assign-3', orderId: 'CZ-84380', issueType: 'Driver Behavior', assignedOn: '2025-10-19T09:00:00Z', status: 'pending' },
                        { assignmentId: 'assign-4', orderId: 'CZ-84375', issueType: 'Missing Item', assignedOn: '2025-10-18T15:00:00Z', status: 'completed' },
                        { assignmentId: 'assign-5', orderId: 'CZ-84374', issueType: 'Wrong Order', assignedOn: '2025-10-18T14:00:00Z', status: 'completed' },
                        { assignmentId: 'assign-6', orderId: 'CZ-84371', issueType: 'Spillage', assignedOn: '2025-10-17T11:00:00Z', status: 'escalated' },
                    ];
                    
                    let filtered = allOrders.filter(o => {
                        const searchMatch = search.length < 2 ? true : o.orderId.toLowerCase().includes(search.toLowerCase());
                        const statusMatch = status === 'all' ? true : o.status === status;
                        return searchMatch && statusMatch;
                    });

                    const totalItems = filtered.length;
                    const paginated = filtered.slice((page - 1) * limit, page * limit);

                    resolve({
                        data: paginated,
                        total: totalItems,
                        page: page,
                        limit: limit,
                        totalPages: Math.ceil(totalItems / limit)
                    });
                }, 800));
            },
            getOrderDetails: async (orderId) => {
                // SIMULATE API CALL
                return new Promise(resolve => setTimeout(() => resolve({
                    id: orderId,
                    employee_name: 'Nisrin Abdullah-CU',
                    reason: 'Damaged Order',
                    details: 'Customer reported the cake was crushed upon arrival.',
                    amount: 77.00,
                    compensation_against: 'Store',
                    chefz: 'Cakeology Rawabi',
                    status: 'Delivered'
                }), 500));
            },
            submitReview: async (payload) => {
                // SIMULATE API CALL
                console.log('Submitting Review:', payload);
                return new Promise(resolve => setTimeout(() => resolve({ success: true }), 1000));
            },
             getTeamMembers: async () => {
                return new Promise(resolve => setTimeout(() => resolve([
                    { name: "Fahad Al-Qahtani", role: "Quality Agent", color: "#00bfff"},
                    { name: "Noura Al-Dossari", role: "Quality Agent", color: "#ff69b4"},
                    { name: "Ahmed Khan", role: "Senior Quality Agent", color: "#28a745"},
                    { name: "Ali Al-Mansoori", role: "Quality Manager", color: "#ffc107"},
                ]), 500));
            }
        };

        // --- GLOBAL STATE MANAGEMENT ---
        const AppState = {
            currentUser: null,
            orders: {
                data: [],
                page: 1,
                totalPages: 1,
                limit: 10,
                search: '',
                status: 'all'
            },
            team: {
                members: [],
                schedule: []
            },
            autoRefreshInterval: null,
        };

        // --- UTILITY & RENDERING FUNCTIONS ---
        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            }, 10);
        };

        const getInitials = (name) => {
            if (!name) return '';
            const names = name.split(' ');
            return names.length > 1 ? `${names[0][0]}${names[names.length - 1][0]}`.toUpperCase() : (names[0]?.[0] || '').toUpperCase();
        };

        const renderUI = () => {
            if (AppState.currentUser) {
                const user = AppState.currentUser;
                document.getElementById('sidebar-username').textContent = user.name;
                document.getElementById('welcome-username').textContent = user.name;
                document.getElementById('sidebar-avatar-initials').textContent = getInitials(user.name);
                document.getElementById('kpi-reviews').textContent = user.kpis.reviews;
                document.getElementById('kpi-open-cases').textContent = user.kpis.openCases;
                document.getElementById('kpi-quality-score').textContent = `${user.kpis.qualityScore}%`;
                document.getElementById('kpi-escalation-rate').textContent = `${user.kpis.escalationRate}%`;
            }
        };

        const renderOrders = () => {
            const tbody = document.getElementById('orders-table-body');
            const { data } = AppState.orders;
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 2rem;">No orders found.</td></tr>`;
                return;
            }
            tbody.innerHTML = data.map(order => `
                <tr>
                    <td>${order.orderId}</td>
                    <td>${order.issueType}</td>
                    <td>${new Date(order.assignedOn).toLocaleDateString()}</td>
                    <td><span class="status-badge status-${order.status}">${order.status.replace('_', ' ')}</span></td>
                    <td style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary btn-sm" data-action="view" data-order-id="${order.orderId}">View</button>
                        <button class="btn btn-primary btn-sm" data-action="review" data-order-id="${order.orderId}">Review</button>
                    </td>
                </tr>
            `).join('');
        };
        
        const renderTeamMembers = () => {
            const grid = document.getElementById('team-grid');
            grid.innerHTML = AppState.team.members.map(member => `
                 <div class="team-member-card">
                    <div class="team-member-avatar-initials" style="background-color: ${member.color};">${getInitials(member.name)}</div>
                    <div class="team-member-name">${member.name}</div>
                    <div class="team-member-role">${member.role}</div>
                </div>
            `).join('');
        };

        const renderPagination = () => {
            const { page, totalPages, data, total } = AppState.orders;
            const start = total === 0 ? 0 : (page - 1) * 10 + 1;
            const end = start + data.length - 1;
            document.getElementById('pagination-info').textContent = `Showing ${start}-${end} of ${total}`;
            document.getElementById('prev-page-btn').disabled = page <= 1;
            document.getElementById('next-page-btn').disabled = page >= totalPages;
        };
        
        const createModal = (id, title, bodyHtml, footerHtml) => {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = id;
            modal.innerHTML = `
                <div class="modal-box">
                    <div class="modal-header">
                        <h3 class="modal-title">${title}</h3>
                        <button class="modal-close-btn">&times;</button>
                    </div>
                    <div class="modal-body">${bodyHtml}</div>
                    <div class="modal-footer">${footerHtml}</div>
                </div>
            `;
            document.getElementById('modals-container').appendChild(modal);
            
            modal.querySelector('.modal-close-btn').addEventListener('click', () => modal.classList.remove('show'));
            modal.addEventListener('click', (e) => {
                if(e.target === modal) modal.classList.remove('show');
            });

            return modal;
        }

        // --- DATA FETCHING & LOGIC ---
        const loadInitialData = async () => {
            AppState.currentUser = await ApiService.getCurrentUser();
            AppState.team.members = await ApiService.getTeamMembers();
            renderUI();
            renderTeamMembers();
            switchTab('dashboard');
        };

        const fetchAndRenderOrders = async () => {
            const tbody = document.getElementById('orders-table-body');
            tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 2rem;">Loading orders...</td></tr>`;
            const result = await ApiService.getAssignedOrders(AppState.orders);
            AppState.orders.data = result.data;
            AppState.orders.totalPages = result.totalPages;
            AppState.orders.total = result.total;
            renderOrders();
            renderPagination();
        };

        // --- EVENT HANDLERS ---
        const handleTabSwitch = (tabId) => {
            document.querySelectorAll('.sidebar-nav li').forEach(li => li.classList.remove('active'));
            document.querySelector(`a[data-tab="${tabId}"]`).parentElement.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            const title = document.querySelector(`a[data-tab="${tabId}"] span`).textContent;
            document.getElementById('page-title').textContent = title;
            
            if (tabId === 'my-assigned-orders') {
                fetchAndRenderOrders();
            }
        };

        const handleOrderAction = async (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button) return;

            const action = button.dataset.action;
            const orderId = button.dataset.orderId;

            if (action === 'view') {
                const details = await ApiService.getOrderDetails(orderId);
                const viewModal = createModal('view-order-modal', `Order Details: ${orderId}`, 
                `<div><strong>Original Employee:</strong> ${details.employee_name}</div>
                 <div><strong>Reason:</strong> ${details.reason}</div>
                 <div><strong>Details:</strong> ${details.details}</div>`, 
                `<button class="btn btn-secondary" id="close-view-modal">Close</button>`);
                viewModal.classList.add('show');
                viewModal.querySelector('#close-view-modal').addEventListener('click', () => viewModal.remove());
            }
            
            if (action === 'review') {
                const reviewModal = createModal('review-order-modal', `Review Order: ${orderId}`,
                `<form id="review-form">
                    <div class="form-group">
                        <label for="action_correctness">Action Correctness</label>
                        <select id="action_correctness" class="form-control" required>
                            <option value="correct">Correct Action</option>
                            <option value="error">Error in Action</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="error_cause">Error Cause (if any)</label>
                        <input type="text" id="error_cause" class="form-control">
                    </div>
                     <div class="form-group">
                        <label for="modification_details">Comments</label>
                        <textarea id="modification_details" class="form-control" rows="4"></textarea>
                    </div>
                </form>`,
                `<button class="btn btn-secondary" id="cancel-review">Cancel</button>
                 <button type="submit" form="review-form" class="btn btn-primary">Submit Review</button>`);
                
                reviewModal.classList.add('show');
                reviewModal.querySelector('#cancel-review').addEventListener('click', () => reviewModal.remove());
                reviewModal.querySelector('#review-form').addEventListener('submit', async (ev) => {
                    ev.preventDefault();
                    button.textContent = "Submitting...";
                    button.disabled = true;
                    await ApiService.submitReview({
                        orderId,
                        correctness: document.getElementById('action_correctness').value,
                        cause: document.getElementById('error_cause').value,
                        details: document.getElementById('modification_details').value
                    });
                    showToast(`Review for order ${orderId} submitted successfully.`, 'success');
                    reviewModal.remove();
                    fetchAndRenderOrders();
                });
            }
        };

        // --- INITIALIZATION & EVENT LISTENERS ---
        document.querySelectorAll('.sidebar-nav a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                handleTabSwitch(link.dataset.tab);
            });
        });

        document.getElementById('orders-table-body').addEventListener('click', handleOrderAction);
        
        let searchTimeout;
        document.getElementById('orders-search-input').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = e.target.value;
                if(searchTerm.length === 0 || searchTerm.length >= 2) {
                    AppState.orders.page = 1;
                    AppState.orders.search = searchTerm;
                    fetchAndRenderOrders();
                }
            }, 500); // Debounce
        });
        
        document.getElementById('filter-status').addEventListener('change', (e) => {
            AppState.orders.page = 1;
            AppState.orders.status = e.target.value;
            fetchAndRenderOrders();
        });

        document.getElementById('prev-page-btn').addEventListener('click', () => {
            if (AppState.orders.page > 1) {
                AppState.orders.page--;
                fetchAndRenderOrders();
            }
        });

        document.getElementById('next-page-btn').addEventListener('click', () => {
            if (AppState.orders.page < AppState.orders.totalPages) {
                AppState.orders.page++;
                fetchAndRenderOrders();
            }
        });

        // Start the application
        loadInitialData();
        
        // Setup Auto-Refresh
        AppState.autoRefreshInterval = setInterval(() => {
            showToast('Auto-refreshing data...', 'info');
            loadInitialData(); // Reload user KPIs
            if (document.getElementById('my-assigned-orders').classList.contains('active')) {
                fetchAndRenderOrders(); // Reload orders if on the orders tab
            }
        }, 30000);

    });
    </script>
</body>
</html>
