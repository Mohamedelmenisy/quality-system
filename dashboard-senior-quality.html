
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Senior Quality Portal - QualityX</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23007BFF'/%3E%3Ctext x='50' y='55' font-family='Poppins, sans-serif' font-size='60' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='middle'%3EQ%3C/text%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        // The api-client.js content is embedded here for a single-file solution.
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        const SUPABASE_URL = "https://otaztiyatvbajswowdgs.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im90YXp0aXlhdHZiYWpzd293ZGdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MDI4NTYsImV4cCI6MjA3NjI3ODg1Nn0.wmAvCpj8TpKjeuWF1OrjvXnxucMCFhhQrK0skA0SQhc";

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        window.supabase = supabase; // Make it globally accessible

        // ==================== AUTH FUNCTIONS ====================
        async function signUp(email, password, name, department = null) { try { const { data, error } = await supabase.auth.signUp({ email: email, password: password, options: { data: { name: name, department: department } } }); if (error) throw error; const user = data.user; if (user) { const { error: insertError } = await supabase.from('users').insert({ id: user.id, name: name, email: email, role: 'quality', department: department, first_login: new Date(), status: 'offline' }); if (insertError) throw insertError; } return user; } catch (error) { console.error('SignUp Error:', error); throw error; } }
        async function signIn(email, password) { try { const { data, error } = await supabase.auth.signInWithPassword({ email: email, password: password }); if (error) throw error; const user = data.user; await supabase.from('users').update({ last_seen: new Date(), status: 'online' }).eq('id', user.id); return user; } catch (error) { console.error('SignIn Error:', error); throw error; } }
        async function signOut() { try { const { error } = await supabase.auth.signOut(); if (error) throw error; } catch (error) { console.error('Logout error:', error); throw error; } }
        async function getCurrentUser() { try { const { data, error } = await supabase.auth.getUser(); if (error) return null; return data?.user || null; } catch (error) { return null; } }

        // ==================== USER DATA FUNCTIONS ====================
        async function getUserData(email) { try { const { data, error } = await supabase.from('users').select('*').eq('email', email).single(); if (error || !data) throw new Error('User data not found'); return data; } catch (error) { console.error('GetUserData error:', error); throw error; } }
        async function getUserById(userId) { try { const { data, error } = await supabase.from('users').select('*').eq('id', userId).single(); if (error) throw error; return data; } catch (error) { console.error('GetUserById error:', error); throw error; } }
        async function updateUserProfile(userId, updates) { try { const { data, error } = await supabase.from('users').update(updates).eq('id', userId).select().single(); if (error) throw error; return data; } catch (error) { console.error('UpdateUserProfile error:', error); throw error; } }

        // ==================== COMPANY EMPLOYEE FUNCTIONS ====================
        async function getCompanyEmployees() { try { const { data, error } = await supabase.from('employees').select('*').order('employee_name', { ascending: true }); if (error) throw error; return data; } catch (error) { console.error('GetCompanyEmployees error:', error); throw error; } }
        async function addCompanyEmployee(employeeData) { try { const { data, error } = await supabase.from('employees').insert(employeeData).select().single(); if (error) throw error; return data; } catch (error) { console.error('AddCompanyEmployee error:', error); throw error; } }
        async function updateCompanyEmployee(employeeId, updates) { try { const { data, error } = await supabase.from('employees').update(updates).eq('id', employeeId).select().single(); if (error) throw error; return data; } catch (error) { console.error('UpdateCompanyEmployee error:', error); throw error; } }

        // ==================== ORDER FUNCTIONS ====================
        async function getOrders(filters = {}) { try { let query = supabase.from('orders').select('*').order('created_at', { ascending: false }); if (filters.order_id) query = query.ilike('order_id', `%${filters.order_id}%`); if (filters.from_date) query = query.gte('created_at', filters.from_date); if (filters.to_date) query = query.lte('created_at', filters.to_date); if (filters.status) query = query.eq('status', filters.status); const { data, error } = await query; if (error) throw error; return data; } catch (error) { console.error('GetOrders error:', error); throw error; } }
        async function getUnassignedOrders() { try { const { data: assignedOrdersData, error: assignedOrdersError } = await supabase.from('order_assignments').select('order_id'); if (assignedOrdersError) throw assignedOrdersError; const assignedOrderIds = assignedOrdersData.map(a => a.order_id); let query = supabase.from('orders').select('*'); if (assignedOrderIds.length > 0) { query = query.not('order_id', 'in', `(${assignedOrderIds.map(id => `'${id}'`).join(',')})`); } const { data, error } = await query.order('created_at', { ascending: false }); if (error) throw error; return data; } catch (error) { console.error('GetUnassignedOrders error:', error); throw error; } }
        async function assignOrders(orderIds, agentId, assignedById) { try { const assignments = orderIds.map(orderId => ({ order_id: orderId, quality_agent_id: agentId, assigned_by_id: assignedById, status: 'pending' })); const { data, error } = await supabase.from('order_assignments').insert(assignments).select(); if (error) throw error; return data; } catch (error) { console.error('AssignOrders error:', error); throw error; } }
        async function reassignOrder(assignmentId, newAgentId, reassignedById) { try { const { data, error } = await supabase.from('order_assignments').update({ quality_agent_id: newAgentId, assigned_by_id: reassignedById, assigned_at: 'now()', status: 'pending' }).eq('id', assignmentId).select().single(); if (error) throw error; return data; } catch (error) { console.error('ReassignOrder error:', error); throw error; } }
        async function getAssignedOrders(agentId = null, filters = {}) { try { let query = supabase.from('order_assignments').select(`*, orders (*), users!order_assignments_quality_agent_id_fkey (name, email), inquiries (*), escalations (*), quality_reviews (*)`).order('assigned_at', { ascending: false }); if (agentId) query = query.eq('quality_agent_id', agentId); if (filters.status && filters.status !== 'all') query = query.eq('status', filters.status); if (filters.from_date) query = query.gte('assigned_at', filters.from_date); if (filters.to_date) query = query.lte('assigned_at', `${filters.to_date}T23:59:59`); const { data, error } = await query; if (error) throw error; return data; } catch (error) { console.error('GetAssignedOrders error:', error); throw error; } }

        // ==================== QUALITY REVIEW FUNCTIONS ====================
        async function submitReview(assignmentId, reviewData) { try { const { data: review, error: reviewError } = await supabase.from('quality_reviews').insert({ assignment_id: assignmentId, action_correctness: reviewData.action_correctness, department: reviewData.department, modified_reason: reviewData.modified_reason, modification_details: reviewData.notes, reviewed_at: new Date(), employee_raw_name: reviewData.employee_raw_name }).select('id, employee_raw_name').single(); if (reviewError) throw reviewError; if (reviewData.action_correctness === 'error') { const employeeNameToFind = review.employee_raw_name.replace(/"/g, '').trim(); let employee = null; const { data: employeeByUsername } = await supabase.from('employees').select('id').eq('employee_username', employeeNameToFind).single(); if (employeeByUsername) { employee = employeeByUsername; } else { const { data: employeeByName } = await supabase.from('employees').select('id').eq('employee_name', employeeNameToFind).single(); employee = employeeByName; } if (employee) { const { error: insertError } = await supabase.from('errors').insert({ review_id: review.id, employee_id: employee.id, status: 'closed', created_at: new Date() }); if (insertError) throw insertError; } else { console.error(`CRITICAL: Could not find employee: "${employeeNameToFind}". Error NOT logged.`); } } await supabase.from('order_assignments').update({ status: 'completed', completed_at: 'now()' }).eq('id', assignmentId); return review; } catch (error) { console.error('SubmitReview error:', error); throw error; } }

        // ==================== ERROR FUNCTIONS ====================
        async function getPendingErrors() { try { const { data, error } = await supabase.from('errors').select(`*, quality_reviews (action_correctness, department, modified_reason, order_assignments ( orders (*) ) ), error_responses (*), employee:employees (employee_name, employee_username)`).eq('status', 'pending_response').order('created_at', { ascending: false }); if (error) throw error; return data; } catch (error) { console.error('GetPendingErrors error:', error); throw error; } }
        async function submitFinalDecision(errorId, decidedById, decision, notes = '') { try { const { data, error } = await supabase.from('final_decisions').insert({ error_id: errorId, decided_by_id: decidedById, decision: decision, notes: notes, decided_at: new Date() }).select().single(); if (error) throw error; return data; } catch (error) { console.error('SubmitFinalDecision error:', error); throw error; } }
        async function getAppealedErrors() { try { const { data, error } = await supabase.rpc('get_appealed_errors'); if (error) throw error; return data; } catch (error) { console.error('GetAppealedErrors error:', error); throw error; } }
        async function getFinalizedDecisions() { try { const { data, error } = await supabase.rpc('get_finalized_decisions'); if (error) throw error; return data; } catch (error) { console.error('GetFinalizedDecisions error:', error); throw error; } }

        // ==================== ESCALATION FUNCTIONS ====================
        async function getEscalations(userId = null, filters = {}) { try { let query = supabase.from('escalations').select(`*, order_assignments!escalations_assignment_id_fkey (*, orders (*), users!order_assignments_quality_agent_id_fkey (name)), escalated_by:users!escalations_escalated_by_id_fkey (name), escalated_to:users!escalations_escalated_to_id_fkey (name)`).order('escalated_at', { ascending: false }); if (userId) query = query.eq('escalated_to_id', userId); if (filters.status) query = query.eq('status', filters.status); const { data, error } = await query; if (error) throw error; return data; } catch (error) { console.error('GetEscalations error:', error); throw error; } }
        async function resolveEscalation(escalationId, feedback) { try { const { data: escalationData, error: fetchError } = await supabase.from('escalations').select('escalated_by_id, order_assignments!inner(orders(order_id))').eq('id', escalationId).single(); if (fetchError) throw fetchError; const { data, error } = await supabase.from('escalations').update({ status: 'resolved', feedback: feedback, resolved_at: new Date().toISOString() }).eq('id', escalationId).select().single(); if (error) throw error; if (escalationData) { await createNotification(escalationData.escalated_by_id, `Your escalation for order ${escalationData.order_assignments?.orders?.order_id || ''} has been resolved.`, 'info'); } return data; } catch (error) { console.error('ResolveEscalation error:', error); throw error; } }

        // ==================== TEAM & SCHEDULING FUNCTIONS ====================
        async function getTeamMembers(roles = []) { try { let query = supabase.from('users').select('*').eq('is_active', true).order('name'); if (roles.length > 0) query = query.in('role', roles); const { data, error } = await query; if (error) throw error; return data; } catch (error) { console.error('GetTeamMembers error:', error); throw error; } }
        async function getTeamSchedule() { try { const { data, error } = await supabase.from('team_schedule').select(`*, users (name, role)`).order('user_id').order('shift_date'); if (error) throw error; return data; } catch (error) { console.error('GetTeamSchedule error:', error); return []; } }
        async function updateTeamSchedule(scheduleData) { try { const { data, error } = await supabase.from('team_schedule').upsert(scheduleData).select(); if (error) throw error; return data; } catch (error) { console.error('UpdateTeamSchedule error:', error); throw error; } }

        // ==================== NOTIFICATION FUNCTIONS ====================
        async function getNotifications(userId) { try { const { data, error } = await supabase.from('notifications').select('*').eq('user_id', userId).eq('is_read', false).order('created_at', { ascending: false }).limit(10); if (error) throw error; return data; } catch (error) { console.error('GetNotifications error:', error); throw error; } }
        async function markNotificationAsRead(notificationId) { try { const { data, error } = await supabase.from('notifications').update({ is_read: true }).eq('id', notificationId).select().single(); if (error) throw error; return data; } catch (error) { console.error('MarkNotificationAsRead error:', error); throw error; } }
        async function createNotification(userId, message, type = 'info') { try { const { data, error } = await supabase.from('notifications').insert({ user_id: userId, message: message, type: type, is_read: false, created_at: new Date() }).select().single(); if (error) throw error; return data; } catch (error) { console.error('CreateNotification error:', error); throw error; } }

        // ==================== ANALYTICS & REPORTING FUNCTIONS ====================
        async function getPerformanceMetrics() { try { const { data, error } = await supabase.rpc('get_senior_dashboard_kpis'); if (error) throw error; const metrics = data[0]; return { completedOrders: metrics.reviews_today || 0, pendingEscalations: metrics.pending_escalations || 0, avgResolutionTime: metrics.avg_resolution_time_minutes ? Math.round(metrics.avg_resolution_time_minutes) : 0, accuracyRate: metrics.team_accuracy ? parseFloat(metrics.team_accuracy).toFixed(1) : 0.0 }; } catch (error) { return { completedOrders: 0, pendingEscalations: 0, avgResolutionTime: 0, accuracyRate: 0.0 }; } }
        async function getTeamPerformance() { try { const { data, error } = await supabase.rpc('get_team_performance'); if (error) throw error; return data; } catch (error) { console.error('GetTeamPerformance error:', error); return []; } }
        async function getErrorTrends() { try { const { data, error } = await supabase.from('errors').select('created_at').order('created_at', { ascending: true }); if (error) throw error; return data; } catch (error) { console.error('GetErrorTrends error:', error); return []; } }

        // ==================== DATA IMPORT FUNCTIONS ====================
        async function importOrdersFromCSV(csvData) { try { const orders = csvData.map(row => ({ order_id: row.order_id, employee_name: row.employee_name, admin_id: row.admin_id, reason: row.reason, amount: parseFloat(row.amount) || 0, chefz: row.chefz, order_status: row.order_status, requested_delivery_date: row.requested_delivery_date, payment_type: row.payment_type, raw_data: row, created_at: new Date() })); const { data, error } = await supabase.from('orders').insert(orders).select(); if (error) throw error; const qualityAgents = await getTeamMembers('quality'); for (const agent of qualityAgents) { await createNotification(agent.id, `${orders.length} new orders have been imported.`, 'info'); } return data; } catch (error) { console.error('ImportOrdersFromCSV error:', error); throw error; } }

        // ==================== REAL-TIME SUBSCRIPTIONS ====================
        function subscribeToNotifications(userId, callback) { try { return supabase.channel('notifications').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications', filter: `user_id=eq.${userId}` }, callback).subscribe(); } catch (error) { console.error('SubscribeToNotifications error:', error); return { unsubscribe: () => {} }; } }
        function subscribeToAssignmentUpdates(callback) { try { return supabase.channel('assignment-updates').on('postgres_changes', { event: '*', schema: 'public', table: 'order_assignments' }, callback).subscribe(); } catch (error) { console.error('SubscribeToAssignmentUpdates error:', error); return { unsubscribe: () => {} }; } }
        function subscribeToEscalations(callback) { try { return supabase.channel('escalations-channel').on('postgres_changes', { event: '*', schema: 'public', table: 'escalations' }, callback).subscribe(); } catch (error) { console.error('SubscribeToEscalations error:', error); return { unsubscribe: () => {} }; } }

        // Make functions globally available
        const functions = { supabase, getCurrentUser, getUserById, getUnassignedOrders, getAssignedOrders, assignOrders, getPendingErrors, getAppealedErrors, getFinalizedDecisions, submitFinalDecision, getPerformanceMetrics, getTeamMembers, getTeamSchedule, updateTeamSchedule, getNotifications, markNotificationAsRead, createNotification, subscribeToNotifications, getErrorTrends, getTeamPerformance, importOrdersFromCSV, getCompanyEmployees, addCompanyEmployee, updateCompanyEmployee, getEscalations, resolveEscalation, reassignOrder, subscribeToAssignmentUpdates, subscribeToEscalations };
        Object.assign(window, functions);
    </script>
    <style>
        :root {
            --primary-color: #007BFF;
            --primary-color-darker: #0056b3;
            --bg-color: #0d1117;
            --sidebar-bg: #161b22;
            --card-bg: #161b22;
            --text-color: #c9d1d9;
            --text-muted-color: #8b949e;
            --border-color: #30363d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --font-body: 'Poppins', sans-serif;
            --border-radius-base: 0.5rem;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-body); background-color: var(--bg-color); color: var(--text-color); font-size: 14px; }
        .layout { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; position: fixed; height: 100%; z-index: 1000; }
        .sidebar-header { padding: 1.5rem; display: flex; align-items: center; gap: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .sidebar-logo { height: 32px; fill: var(--primary-color); }
        .sidebar-title { font-size: 1.25rem; color: var(--primary-color); font-weight: 700; }
        .sidebar-nav-container { flex-grow: 1; overflow-y: auto; padding-top: 1rem; }
        .nav-group { margin-bottom: 1.5rem; padding: 0 1.5rem; }
        .nav-group-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted-color); font-weight: 600; margin-bottom: 0.75rem; }
        .sidebar-nav { list-style: none; padding: 0; }
        .sidebar-nav a { display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1rem; margin: 0.25rem 0; text-decoration: none; color: var(--text-muted-color); font-weight: 500; border-radius: 0.5rem; transition: all 0.2s ease; cursor: pointer; white-space: nowrap; }
        .sidebar-nav a:hover, .sidebar-nav li.active a { background-color: var(--primary-color); color: white; }
        .sidebar-footer { padding: 1.5rem; border-top: 1px solid var(--border-color); }
        .user-profile-widget { display: flex; align-items: center; gap: 12px; }
        .avatar-initials { width: 44px; height: 44px; border-radius: 50%; background-color: var(--primary-color); color: white; font-weight: 700; font-size: 1rem; display: inline-flex; align-items: center; justify-content: center; }
        .user-name { font-weight: 600; font-size: 1rem; }
        .user-role { font-size: 0.8rem; color: var(--text-muted-color); }
        .main-wrapper { flex-grow: 1; margin-left: 260px; display: flex; flex-direction: column; }
        .topbar { background-color: var(--sidebar-bg); border-bottom: 1px solid var(--border-color); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 999; }
        .page-title { font-size: 1.5rem; color: var(--text-color); font-weight: 700; }
        .header-actions { display: flex; align-items: center; gap: 1.5rem; }
        .connection-status { width: 10px; height: 10px; border-radius: 50%; transition: background-color 0.3s ease; }
        .connection-status.online { background-color: var(--success-color); box-shadow: 0 0 8px var(--success-color); }
        .connection-status.offline { background-color: var(--danger-color); box-shadow: 0 0 8px var(--danger-color); }
        .main-content { padding: 2rem; flex-grow: 1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .widget { background-color: var(--card-bg); border-radius: var(--border-radius-base); padding: 1.5rem; border: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        .widget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .widget h3 { font-size: 1.25rem; color: var(--text-color); font-weight: 600; }
        .results-table-container { overflow-x: auto; }
        .results-table { width: 100%; border-collapse: collapse; }
        .results-table thead th { padding: 1rem 1.5rem; text-align: left; background-color: #21262d; font-size: 0.8rem; text-transform: uppercase; color: var(--text-muted-color); font-weight: 600; white-space: nowrap; border-bottom: 1px solid var(--border-color); }
        .results-table tbody td { padding: 1rem 1.5rem; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        .results-table .wrap-text { white-space: normal; min-width: 200px; }
        .results-table tbody tr:last-child td { border-bottom: none; }
        .results-table tbody tr:hover { background-color: #21262d; }
        .btn { padding: 0.6rem 1.2rem; border-radius: 0.5rem; border: 1px solid transparent; cursor: pointer; font-weight: 600; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn:disabled { background-color: #30363d !important; color: #8b949e !important; cursor: not-allowed; border-color: #30363d !important; }
        .btn-primary { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .btn-primary:hover { background-color: var(--primary-color-darker); border-color: var(--primary-color-darker); }
        .btn-secondary { background-color: #21262d; color: var(--text-color); border-color: var(--border-color); }
        .btn-secondary:hover { border-color: #8b949e; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.875rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1050; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-overlay.show { display: flex !important; animation: fadeIn 0.3s ease; }
        .modal-box { background: var(--card-bg); padding: 2.5rem; border-radius: var(--border-radius-base); border: 1px solid var(--border-color); width: 90%; max-width: 700px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1.5rem; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }
        .modal-close-btn { background: none; border: none; color: var(--text-muted-color); font-size: 1.5rem; cursor: pointer; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); }
        .detail-item { background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
        .detail-item strong { display: block; color: var(--text-muted-color); font-size: 0.8rem; margin-bottom: 5px; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;}
        .chart-container { height: 350px; }
        .filter-panel { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; padding: 1rem; background-color: #0d1117; border: 1px solid var(--border-color); border-radius: var(--border-radius-base); margin-bottom: 1.5rem; }
        .filter-panel select, .filter-panel input { background: #21262d; border-radius: 8px; color: var(--text-color); padding: 8px 12px; border: 1px solid var(--border-color); }
        .status-badge { padding: 0.3em 0.7em; border-radius: 20px; font-size: 0.75rem; font-weight: 600; color: white; text-transform: capitalize; }
        .status-pending, .status-under_review { background-color: var(--warning-color); color: black; }
        .status-completed, .status-resolved, .status-overturned { background-color: var(--success-color); }
        .status-closed, .status-rejected { background-color: var(--danger-color); }
        .status-modified { background-color: orange; color: black; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 0.5rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; background: #21262d; border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); padding: 10px 12px; }
        .placeholder-content { padding: 3rem; text-align:center; color: var(--text-muted-color); border: 2px dashed var(--border-color); border-radius: var(--border-radius-base); }
        #welcome-message h2 { font-size: 1.75rem; font-weight: 700; }
        #welcome-message p { color: var(--text-muted-color); }
        .notification-bell { position: relative; }
        .notification-btn { background: none; border: none; color: var(--text-muted-color); font-size: 24px; cursor: pointer; padding: 5px; }
        .notification-dropdown { display: none; position: absolute; right: 0; top: 120%; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius-base); width: 320px; box-shadow: 0 8px 16px rgba(0,0,0,0.3); z-index: 1010; }
        .notification-dropdown.show { display: block; animation: fadeIn 0.2s; }
        .notification-header { padding: 1rem; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .notification-list { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; }
        .notification-item { padding: 1rem; border-bottom: 1px solid var(--border-color); font-size: 14px; }
        .empty-state { text-align: center; padding: 40px; color: var(--text-muted-color); }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { background: var(--card-bg); border-left: 4px solid var(--info-color); border-radius: var(--border-radius-base); padding: 15px 20px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; max-width: 350px; animation: slideInRight 0.3s ease; }
        .toast.success { border-color: var(--success-color); }
        .toast.error { border-color: var(--danger-color); }
        .toast.warning { border-color: var(--warning-color); }
        .toast-icon { font-size: 20px; }
        .toast-message { font-size: 14px; color: var(--text-muted-color); }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .pagination-controls { display: flex; justify-content: flex-end; align-items: center; gap: 1rem; margin-top: 1.5rem; }
        .pagination-controls .page-info { font-size: 0.9rem; color: var(--text-muted-color); }
    </style>
</head>
<body class="dark">
    <div class="layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <svg class="sidebar-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" rx="20" fill="currentColor"/><text x="50" y="55" font-family="Poppins, sans-serif" font-size="60" font-weight="bold" fill="#161b22" text-anchor="middle" dominant-baseline="middle">Q</text></svg>
                <h1 class="sidebar-title">QualityX</h1>
            </div>
            <div class="sidebar-nav-container">
                 <div class="nav-group">
                    <h2 class="nav-group-title">Menu</h2>
                    <ul class="sidebar-nav">
                        <li class="active"><a data-tab="dashboard">📊 Dashboard</a></li>
                        <li><a data-tab="assignments">📋 Assignments</a></li>
                        <li><a data-tab="escalations">🚨 Escalations</a></li>
                        <li><a data-tab="team-scheduling">📅 Team Scheduling</a></li>
                        <li><a data-tab="team-members">👥 Team Members</a></li>
                        <li><a data-tab="company-employees">🏢 Company Employees</a></li>
                        <li><a data-tab="reports-analytics">📄 Reports & Analytics</a></li>
                    </ul>
                </div>
                <div class="nav-group">
                    <h2 class="nav-group-title">Account</h2>
                    <ul class="sidebar-nav">
                         <li><a data-tab="profile">👤 Profile</a></li>
                         <li><a data-tab="settings">⚙️ Settings</a></li>
                         <li><a id="logout-btn">🚪 Logout</a></li>
                    </ul>
                </div>
            </div>
            <div class="sidebar-footer">
                <div class="user-profile-widget">
                    <div class="avatar-initials" id="sidebar-avatar-initials">ME</div>
                    <div>
                        <div class="user-name" id="sidebar-username">Mohamed Elmenisy</div>
                        <div class="user-role">Senior Quality Analyst</div>
                    </div>
                </div>
            </div>
        </aside>

        <div class="main-wrapper">
            <header class="topbar">
                <h2 class="page-title" id="page-title">Dashboard</h2>
                 <div class="header-actions">
                    <input type="search" placeholder="Global search..." class="filter-panel" style="padding: 10px 14px; margin: 0; width: 250px;">
                    <div class="notification-bell">
                        <button id="notification-btn" class="notification-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                        </button>
                        <div id="notification-dropdown" class="notification-dropdown">
                            <div class="notification-header">Notifications</div>
                            <ul class="notification-list" id="notification-list"><li class="notification-item">Loading...</li></ul>
                        </div>
                    </div>
                    <div id="connection-status-indicator" class="connection-status" title="Connection Status"></div>
                </div>
            </header>

            <main class="main-content">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content active">
                     <div id="welcome-message" style="margin-bottom: 2rem;">
                        <h2 id="welcome-user-h2">Welcome, Mohamed!</h2>
                        <p>Here is a summary of your activity and team oversight.</p>
                    </div>
                    <div class="kpi-grid">
                         <div class="widget"><h3>Reviews Today</h3><p style="font-size: 2rem; font-weight: 700;" id="reviews-today">0</p></div>
                         <div class="widget"><h3>Pending Escalations</h3><p style="font-size: 2rem; font-weight: 700; color: var(--warning-color);" id="pending-escalations">0</p></div>
                         <div class="widget"><h3>Avg. Resolution Time</h3><p style="font-size: 2rem; font-weight: 700;" id="avg-resolution-time">0m</p></div>
                         <div class="widget"><h3>Team Accuracy</h3><p style="font-size: 2rem; font-weight: 700; color: var(--success-color);" id="team-accuracy">0%</p></div>
                    </div>
                     <div class="widget">
                         <h3>Team Performance Analysis</h3>
                         <div class="charts-grid">
                             <div class="chart-container"><canvas id="teamPerformanceChart"></canvas></div>
                             <div class="chart-container"><canvas id="errorTrendsChart"></canvas></div>
                         </div>
                     </div>
                </div>

                <!-- Escalations Tab -->
                <div id="escalations" class="tab-content">
                    <div class="widget" style="display: none;">
                         <h3>Pending Agent Responses</h3>
                    </div>
                    <div class="widget">
                        <div class="widget-header">
                            <h3>Appealed Errors (<span id="appealed-errors-count">0</span>)</h3>
                        </div>
                        <p style="color: var(--text-muted-color); margin-top: -1rem; margin-bottom: 1.5rem;">Errors appealed by agents awaiting your final decision.</p>
                        <div class="results-table-container">
                            <table class="results-table">
                                <thead><tr><th>Order ID</th><th>Agent</th><th class="wrap-text">Error Details</th><th class="wrap-text">Agent's Appeal</th><th>Status</th><th>Action</th></tr></thead>
                                <tbody id="appealed-errors-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="widget">
                        <div class="widget-header">
                            <h3>Direct Escalations (<span id="direct-escalations-count">0</span>)</h3>
                            <button class="btn btn-secondary" id="direct-escalations-csv-btn">Download CSV</button>
                        </div>
                        <div class="filter-panel">
                             <input type="search" id="direct-escalation-search" placeholder="Search by Order ID, Agent, Reason...">
                             <select id="direct-escalation-status-filter"><option value="all">All Statuses</option><option value="pending">Pending</option><option value="resolved">Resolved</option></select>
                        </div>
                        <div class="results-table-container">
                            <table class="results-table">
                                <thead><tr><th>Order ID</th><th>Escalated By</th><th class="wrap-text">Reason</th><th>Date</th><th>Status</th><th>Action</th></tr></thead>
                                <tbody id="direct-escalations-table-body"></tbody>
                            </table>
                        </div>
                        <div class="pagination-controls" id="direct-escalations-pagination"></div>
                    </div>
                    <div class="widget">
                        <div class="widget-header">
                            <h3>Final Decisions Log (<span id="finalized-errors-count">0</span>)</h3>
                            <button class="btn btn-secondary" id="finalized-decisions-csv-btn">Download CSV</button>
                        </div>
                        <div class="results-table-container">
                            <table class="results-table">
                                <thead><tr><th>Order ID</th><th>Agent</th><th class="wrap-text">Error Details</th><th>Your Decision</th><th>Date Finalized</th><th>Action</th></tr></thead>
                                <tbody id="finalized-errors-table-body"></tbody>
                            </table>
                        </div>
                        <div class="pagination-controls" id="finalized-decisions-pagination"></div>
                    </div>
                </div>

                <!-- Assignments Tab -->
                <div id="assignments" class="tab-content">
                    <div class="widget">
                        <div class="widget-header">
                            <h3>Unassigned Orders (<span id="unassigned-count">0</span>)</h3>
                            <div>
                                <button id="import-orders-btn" class="btn btn-secondary">Import Orders</button>
                                <button class="btn btn-secondary" id="unassigned-orders-csv-btn">Download CSV</button>
                            </div>
                        </div>
                        <div class="filter-panel">
                             <input type="search" id="unassigned-search" placeholder="Search unassigned orders..." style="flex-grow: 1;">
                            <span>Assign selected to:</span>
                            <select id="agent-select" style="flex-grow: 1;"></select>
                            <button id="assign-btn" class="btn btn-primary">Assign Selected</button>
                            <input type="file" id="csv-file-input" accept=".csv" style="display: none;">
                        </div>
                        <div class="results-table-container">
                            <table class="results-table">
                                <thead><tr><th><input type="checkbox" id="select-all-checkbox" /></th><th>Order ID</th><th class="wrap-text">Reason</th><th class="wrap-text">Employee</th><th>Chefz</th><th>Order Status</th><th>Delivery Date</th><th>Payment Type</th></tr></thead>
                                <tbody id="unassigned-table-body"></tbody>
                            </table>
                        </div>
                        <div class="pagination-controls" id="unassigned-orders-pagination"></div>
                    </div>
                    <div class="widget">
                        <div class="widget-header">
                            <h3>Assigned Orders Status</h3>
                            <button class="btn btn-secondary" id="assigned-orders-csv-btn">Download CSV</button>
                        </div>
                        <div class="filter-panel">
                             <input type="search" id="assigned-search" placeholder="Search by Order ID or Agent Name..." style="flex-grow: 1;">
                             <select id="assigned-status-filter"><option value="all">All Statuses</option><option value="pending">Pending</option><option value="completed">Completed</option></select>
                             <input type="date" id="assigned-date-filter" style="color-scheme: dark;">
                             <button id="clear-assigned-filters-btn" class="btn btn-secondary">Clear</button>
                        </div>
                        <div class="results-table-container">
                            <table class="results-table">
                                <thead><tr><th>Order ID</th><th>Agent</th><th>Status</th><th>Date Assigned</th><th>Review Time</th><th>SLA</th><th>Action</th></tr></thead>
                                <tbody id="assigned-table-body"></tbody>
                            </table>
                        </div>
                        <div class="pagination-controls" id="assigned-orders-pagination"></div>
                    </div>
                </div>

                 <!-- All other tabs are omitted for brevity but would follow this structure -->

            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="final-decision-modal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-header"><h3 class="modal-title">Final Decision: Order <span id="decision-order-id"></span></h3><button class="modal-close-btn" data-modal-id="final-decision-modal">×</button></div>
        <div class="modal-body" id="decision-modal-content"></div>
      </div>
    </div>
    <div id="reassign-modal" class="modal-overlay">
      <div class="modal-box" style="max-width: 500px;">
        <div class="modal-header"><h3 class="modal-title">Reassign Order</h3><button class="modal-close-btn" data-modal-id="reassign-modal">×</button></div>
        <div class="modal-body"><p style="color: var(--text-muted-color); margin-bottom: 1.5rem;">Select a new Quality Agent.</p><div class="form-group"><label for="reassign-agent-select">Available Agents</label><select id="reassign-agent-select"></select></div></div>
        <div class="modal-footer"><button class="btn btn-secondary modal-close-btn" data-modal-id="reassign-modal">Cancel</button><button class="btn btn-primary" id="reassign-confirm-btn">Confirm</button></div>
      </div>
    </div>
    <div id="view-details-modal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-header"><h3 class="modal-title" id="view-details-title">Details</h3><button class="modal-close-btn" data-modal-id="view-details-modal">×</button></div>
        <div id="view-details-body" class="modal-body" style="display: flex; flex-direction: column; gap: 1rem;"></div>
        <div class="modal-footer"><button class="btn btn-primary modal-close-btn" data-modal-id="view-details-modal">Close</button></div>
      </div>
    </div>
    <div id="logout-confirm-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 450px; text-align: center;">
            <div class="modal-header" style="border: none; padding-bottom: 0;"><h3 class="modal-title" style="width: 100%; text-align: center;">Confirm Logout</h3></div>
            <div class="modal-body"><p style="margin: 1.5rem 0; color: var(--text-muted-color);">Are you sure you want to log out?</p></div>
            <div class="modal-footer" style="justify-content: center; border: none;"><button type="button" class="btn btn-secondary modal-close-btn" data-modal-id="logout-confirm-modal">Cancel</button><button type="button" id="confirm-logout-btn" class="btn btn-danger">Logout</button></div>
        </div>
    </div>
    <div class="toast-container" id="toast-container"></div>

    <script>
    (function() { // IIFE to prevent global scope pollution
        // Application State
        let currentUser = null;
        let unassignedOrders = { all: [], filtered: [], currentPage: 1 };
        let assignedOrders = { all: [], filtered: [], currentPage: 1 };
        let directEscalations = { all: [], filtered: [], currentPage: 1 };
        let appealedErrors = { all: [], filtered: [], currentPage: 1 };
        let finalizedDecisions = { all: [], filtered: [], currentPage: 1 };
        let teamMembers = [];
        const ITEMS_PER_PAGE = 10;
        let teamPerformanceChart = null, errorTrendsChart = null;

        // Toast Notification System
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icons = { success: '✅', error: '❌', warning: '⚠️', info: 'ℹ️' };
            toast.innerHTML = `<div class="toast-icon">${icons[type]}</div><div class="toast-message">${message}</div>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        // Helper Functions
        const getInitials = (name) => (name ? name.split(' ').map(n => n[0]).join('').toUpperCase() : '');
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('en-GB') : 'N/A';
        const formatDateTime = (d) => d ? new Date(d).toLocaleString('en-GB', { hour12: true }) : 'N/A';
        const showModal = (id) => document.getElementById(id)?.classList.add('show');
        const hideModal = (id) => document.getElementById(id)?.classList.remove('show');

        // Pagination Renderer
        function renderPagination(containerId, dataObject) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const totalItems = dataObject.filtered.length;
            if (totalItems <= ITEMS_PER_PAGE) { container.innerHTML = ''; return; }
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            container.innerHTML = `
                <span class="page-info">Page ${dataObject.currentPage} of ${totalPages}</span>
                <button class="btn btn-secondary prev-btn" ${dataObject.currentPage === 1 ? 'disabled' : ''}>Previous</button>
                <button class="btn btn-secondary next-btn" ${dataObject.currentPage === totalPages ? 'disabled' : ''}>Next</button>
            `;
        }

        // CSV Export
        function exportToCSV(headers, data, filename) {
            const csvRows = [headers.join(',')];
            for (const row of data) {
                const values = headers.map(header => {
                    const escaped = ('' + row[header.toLowerCase().replace(/ /g, '_')]).replace(/"/g, '""');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }
            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Main App Initialization
        async function initApp() {
            restoreActiveTab();
            const user = await window.getCurrentUser();
            if (!user) { window.location.href = 'login.html'; return; }
            const { data: profile } = await window.supabase.from('users').select('*').eq('id', user.id).single();
            currentUser = { ...user, ...profile };
            updateUserInterface();
            initCharts();
            await loadAllData();
            initRealtimeSubscriptions();
            showToast('Senior Dashboard loaded successfully', 'success');
        }

        function updateUserInterface() {
            if (!currentUser) return;
            const name = currentUser.name || "User";
            document.getElementById('sidebar-avatar-initials').textContent = getInitials(name);
            document.getElementById('sidebar-username').textContent = name;
            document.getElementById('welcome-user-h2').textContent = `Welcome, ${name.split(' ')[0]}!`;
        }

        // Data Loading
        async function loadAllData() {
            await Promise.all([
                loadPerformanceMetrics(),
                loadTeamMembers(),
                loadUnassignedOrders(),
                loadAssignedOrders(),
                loadAppealedErrors(),
                loadDirectEscalations(),
                loadFinalizedDecisions(),
                loadNotifications()
            ]);
        }
        
        const loadPerformanceMetrics = async () => {
            const metrics = await window.getPerformanceMetrics();
            document.getElementById('reviews-today').textContent = metrics.completedOrders;
            document.getElementById('pending-escalations').textContent = metrics.pendingEscalations;
            document.getElementById('team-accuracy').textContent = `${metrics.accuracyRate}%`;
            document.getElementById('avg-resolution-time').textContent = `${metrics.avgResolutionTime}m`;
        };
        const loadTeamMembers = async () => { teamMembers = await window.getTeamMembers(['quality', 'helper']); };
        const loadNotifications = async () => {
            const notifications = await window.getNotifications(currentUser.id);
            const list = document.getElementById('notification-list');
            list.innerHTML = notifications.length === 0 ? '<li class="notification-item">No new notifications</li>' : notifications.map(n => `<li class="notification-item">${n.message}</li>`).join('');
        };
        const loadUnassignedOrders = async () => { unassignedOrders.all = await window.getUnassignedOrders(); applyFiltersAndRender('unassigned'); };
        const loadAssignedOrders = async () => { assignedOrders.all = await window.getAssignedOrders(null); applyFiltersAndRender('assigned'); };
        const loadAppealedErrors = async () => { appealedErrors.all = await window.getAppealedErrors(); applyFiltersAndRender('appealed'); };
        const loadDirectEscalations = async () => { directEscalations.all = await window.getEscalations(currentUser.id); applyFiltersAndRender('direct-escalations'); };
        const loadFinalizedDecisions = async () => { finalizedDecisions.all = await window.getFinalizedDecisions(); applyFiltersAndRender('finalized-decisions'); };
        
        // Data Rendering & Filtering
        function applyFiltersAndRender(type) {
            let dataObj, sourceData, filterFn, renderer;
            
            switch(type) {
                case 'unassigned':
                    dataObj = unassignedOrders;
                    filterFn = (item, term) => item.order_id.toLowerCase().includes(term) || item.employee_name.toLowerCase().includes(term);
                    renderer = renderUnassignedOrdersTable;
                    break;
                case 'assigned':
                    dataObj = assignedOrders;
                    filterFn = (item) => {
                        const searchTerm = document.getElementById('assigned-search').value.toLowerCase();
                        const statusFilter = document.getElementById('assigned-status-filter').value;
                        const dateFilter = document.getElementById('assigned-date-filter').value;
                        const searchCorpus = `${item.orders?.order_id || ''} ${item.users?.name || ''}`.toLowerCase();
                        return (!searchTerm || searchCorpus.includes(searchTerm)) &&
                               (statusFilter === 'all' || item.status === statusFilter) &&
                               (!dateFilter || (item.assigned_at && item.assigned_at.startsWith(dateFilter)));
                    };
                    renderer = renderAssignedOrdersTable;
                    break;
                 case 'direct-escalations':
                    dataObj = directEscalations;
                    filterFn = (item) => {
                         const searchTerm = document.getElementById('direct-escalation-search').value.toLowerCase();
                         const statusFilter = document.getElementById('direct-escalation-status-filter').value;
                         const searchCorpus = `${item.order_assignments?.orders?.order_id || ''} ${item.escalated_by?.name || ''} ${item.notes || ''}`.toLowerCase();
                         return (!searchTerm || searchCorpus.includes(searchTerm)) && (statusFilter === 'all' || item.status === statusFilter);
                    };
                    renderer = renderDirectEscalationsTable;
                    break;
                case 'appealed': dataObj = appealedErrors; renderer = renderAppealedErrorsTable; break;
                case 'finalized-decisions': dataObj = finalizedDecisions; renderer = renderFinalizedDecisionsTable; break;
            }
            
            dataObj.filtered = filterFn ? dataObj.all.filter(item => filterFn(item)) : dataObj.all;
            renderer();
        }

        function renderUnassignedOrdersTable() {
            const tableBody = document.getElementById('unassigned-table-body');
            const paginated = paginate(unassignedOrders);
            tableBody.innerHTML = paginated.length ? paginated.map(o => `<tr><td><input type="checkbox" class="order-checkbox" value="${o.order_id}"></td><td>${o.order_id}</td><td class="wrap-text">${o.reason}</td><td class="wrap-text">${o.employee_name}</td><td>${o.chefz || 'N/A'}</td><td>${o.order_status}</td><td>${formatDate(o.requested_delivery_date)}</td><td>${o.payment_type || 'N/A'}</td></tr>`).join('') : `<tr><td colspan="8" class="empty-state">No unassigned orders.</td></tr>`;
            renderPagination('unassigned-orders-pagination', unassignedOrders);
        }

        function renderAssignedOrdersTable() {
            const tableBody = document.getElementById('assigned-table-body');
            const paginated = paginate(assignedOrders);
            tableBody.innerHTML = paginated.length ? paginated.map(a => `<tr><td>${a.orders?.order_id || ''}</td><td>${a.users?.name || ''}</td><td><span class="status-badge status-${a.status}">${a.status}</span></td><td>${formatDateTime(a.assigned_at)}</td><td>${a.completed_at ? Math.round((new Date(a.completed_at) - new Date(a.assigned_at)) / 60000) + 'm' : 'N/A'}</td><td>...</td><td><button class="btn btn-secondary btn-sm view-btn" data-type="assigned" data-id="${a.id}">View</button>${a.status === 'pending' ? `<button class="btn btn-warning btn-sm reassign-btn" data-id="${a.id}">Reassign</button>` : ''}</td></tr>`).join('') : `<tr><td colspan="7" class="empty-state">No assigned orders match filters.</td></tr>`;
            renderPagination('assigned-orders-pagination', assignedOrders);
        }
        
        function renderAppealedErrorsTable() {
            const tableBody = document.getElementById('appealed-errors-table-body');
            tableBody.innerHTML = appealedErrors.all.length ? appealedErrors.all.map(e => `<tr><td>${e.order_id}</td><td>${e.employee_username}</td><td class="wrap-text">${e.error_details}</td><td class="wrap-text">${e.appeal_reason}</td><td><span class="status-badge status-under_review">${e.status}</span></td><td><button class="btn btn-primary btn-sm decide-btn" data-id="${e.error_id}">Decide</button></td></tr>`).join('') : `<tr><td colspan="6" class="empty-state">No appealed errors to review.</td></tr>`;
        }

        function renderDirectEscalationsTable() {
            const tableBody = document.getElementById('direct-escalations-table-body');
            const paginated = paginate(directEscalations);
            tableBody.innerHTML = paginated.length ? paginated.map(e => `<tr><td>${e.order_assignments?.orders?.order_id}</td><td>${e.escalated_by?.name}</td><td class="wrap-text">${e.notes}</td><td>${formatDateTime(e.escalated_at)}</td><td><span class="status-badge status-${e.status}">${e.status}</span></td><td><button class="btn btn-secondary btn-sm view-btn" data-type="escalation" data-id="${e.id}">${e.status === 'pending' ? 'Review' : 'View'}</button></td></tr>`).join('') : `<tr><td colspan="6" class="empty-state">No direct escalations match filters.</td></tr>`;
            renderPagination('direct-escalations-pagination', directEscalations);
        }
        
        function getDisplayStatus(decision) {
            if (decision.toLowerCase() === 'approved') return `<span class="status-badge status-overturned">Overturned</span>`;
            if (decision.toLowerCase() === 'rejected') return `<span class="status-badge status-rejected">Upheld</span>`;
            if (decision.toLowerCase() === 'modified') return `<span class="status-badge status-modified">Modified</span>`;
            return `<span>${decision}</span>`;
        }

        function renderFinalizedDecisionsTable() {
            const tableBody = document.getElementById('finalized-errors-table-body');
            const paginated = paginate(finalizedDecisions);
            tableBody.innerHTML = paginated.length ? paginated.map(d => `<tr><td>${d.order_id}</td><td>${d.employee_username}</td><td class="wrap-text">${d.error_details}</td><td>${getDisplayStatus(d.your_decision)}</td><td>${formatDateTime(d.finalized_at)}</td><td><button class="btn btn-secondary btn-sm view-btn" data-type="decision" data-id="${d.decision_id}">View</button></td></tr>`).join('') : `<tr><td colspan="6" class="empty-state">No finalized decisions found.</td></tr>`;
            renderPagination('finalized-decisions-pagination', finalizedDecisions);
        }

        function paginate(dataObj) {
            const start = (dataObj.currentPage - 1) * ITEMS_PER_PAGE;
            return dataObj.filtered.slice(start, start + ITEMS_PER_PAGE);
        }

        // Real-time Subscriptions
        function initRealtimeSubscriptions() {
            window.supabase.realtime.setAuth(window.supabase.auth.session()?.access_token);
            window.supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
                    window.supabase.realtime.setAuth(session.access_token);
                }
            });
            window.subscribeToAssignmentUpdates(() => { console.log('Assignment updated'); loadAssignedOrders(); });
            window.subscribeToEscalations(() => { console.log('Escalation updated'); loadDirectEscalations(); loadPerformanceMetrics(); });
            window.subscribeToNotifications(currentUser.id, () => { console.log('New notification'); loadNotifications(); });
            
            // Connection Status
            const statusIndicator = document.getElementById('connection-status-indicator');
            window.supabase.realtime.connect();
            window.supabase.realtime.onopen = () => statusIndicator.classList.replace('offline', 'online');
            window.supabase.realtime.onclose = () => statusIndicator.classList.replace('online', 'offline');
            statusIndicator.classList.add(window.supabase.realtime.isConnected() ? 'online' : 'offline');
        }

        // Charts
        function initCharts() {
            Chart.defaults.font.family = "'Poppins', sans-serif";
            Chart.defaults.color = '#c9d1d9';
            const gridColor = 'rgba(255,255,255,0.1)';
            const commonOptions = { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { color: gridColor }, ticks: { color: Chart.defaults.color } }, x: { grid: { display: false }, ticks: { color: Chart.defaults.color } } } };
            
            const teamCtx = document.getElementById('teamPerformanceChart')?.getContext('2d');
            if (teamCtx) {
                window.getTeamPerformance().then(perf => {
                    teamPerformanceChart = new Chart(teamCtx, { type: 'bar', data: { labels: perf.map(p => p.agent_name), datasets: [{ label: 'Accuracy %', data: perf.map(p => p.accuracy), backgroundColor: '#007BFF' }] }, options: { ...commonOptions, plugins: { legend: { display: false } }, scales: { y: { ...commonOptions.scales.y, min: 90 } } } });
                });
            }
            
            const trendsCtx = document.getElementById('errorTrendsChart')?.getContext('2d');
            if (trendsCtx) {
                window.getErrorTrends().then(errors => {
                    const monthlyData = {};
                    const monthLabels = [];
                    const today = new Date();
                    for(let i=5; i>=0; i--) {
                        const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                        const label = d.toLocaleDateString('en-US', { month: 'short' });
                        monthLabels.push(label);
                        monthlyData[label] = 0;
                    }
                    errors.forEach(e => {
                        const month = new Date(e.created_at).toLocaleDateString('en-US', { month: 'short' });
                        if(monthlyData.hasOwnProperty(month)) monthlyData[month]++;
                    });
                    errorTrendsChart = new Chart(trendsCtx, { type: 'line', data: { labels: monthLabels, datasets: [{ label: 'Errors', data: Object.values(monthlyData), borderColor: '#007BFF', fill: true, tension: 0.4, backgroundColor: 'rgba(0, 123, 255, 0.1)' }] }, options: { ...commonOptions, plugins: { legend: { display: false } } } });
                });
            }
        }

        // Event Handlers
        function openDecisionModal(errorId) {
            const error = appealedErrors.all.find(e => e.error_id.toString() === errorId);
            if (!error) return;
            document.getElementById('decision-order-id').textContent = error.order_id;
            document.getElementById('decision-modal-content').innerHTML = `
                <div class="detail-item"><strong>Agent:</strong><span>${error.employee_username}</span></div>
                <div class="detail-item" style="margin-top: 1rem;"><strong>Agent's Appeal:</strong><p>${error.appeal_reason}</p></div>
                <div class="form-group" style="margin-top: 1rem;"><label for="decision-notes">Your Notes (Optional)</label><textarea id="decision-notes" rows="3"></textarea></div>
                <div class="modal-footer"><button class="btn btn-danger" onclick="window.handleFinalDecision('${error.error_id}', 'rejected')">Uphold (Error)</button><button class="btn btn-success" onclick="window.handleFinalDecision('${error.error_id}', 'approved')">Overturn (Not Error)</button></div>`;
            showModal('final-decision-modal');
        }

        window.handleFinalDecision = async (errorId, decision) => {
            const notes = document.getElementById('decision-notes').value;
            const newStatus = decision === 'approved' ? 'overturned' : 'closed';
            try {
                await window.submitFinalDecision(errorId, currentUser.id, decision, notes);
                await window.supabase.from('errors').update({ status: newStatus }).eq('id', errorId);
                const errorData = await window.supabase.from('errors').select('employees(user_id), quality_reviews(order_assignments(orders(order_id)))').eq('id', errorId).single();
                if(errorData.data) {
                    const agentId = errorData.data.employees.user_id;
                    const orderId = errorData.data.quality_reviews.order_assignments.orders.order_id;
                    await window.createNotification(agentId, `Your appeal for order ${orderId} was reviewed: ${decision}.`, 'info');
                }
                showToast('Decision submitted successfully!', 'success');
                hideModal('final-decision-modal');
                loadAppealedErrors();
                loadFinalizedDecisions();
            } catch (err) { showToast(`Failed to submit decision: ${err.message}`, 'error'); }
        };

        function openReassignModal(assignmentId) {
            const select = document.getElementById('reassign-agent-select');
            select.innerHTML = teamMembers.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            document.getElementById('reassign-confirm-btn').dataset.id = assignmentId;
            showModal('reassign-modal');
        }
        
        async function openViewModal(type, id) {
            const modalTitle = document.getElementById('view-details-title');
            const modalBody = document.getElementById('view-details-body');
            let content = '<div class="empty-state">Details not found.</div>';

            if(type === 'assigned') {
                const item = assignedOrders.all.find(i => i.id.toString() === id);
                if(item) {
                     modalTitle.textContent = `Review: ${item.orders?.order_id}`;
                     const review = item.quality_reviews?.[0];
                     content = review ? `<div class="detail-item"><strong>Outcome:</strong> <span>${review.action_correctness}</span></div><div class="detail-item"><strong>Reason:</strong> <span>${review.modified_reason || 'N/A'}</span></div><div class="detail-item"><strong>Notes:</strong> <p>${review.modification_details || 'None'}</p></div>` : `<div class="empty-state">Not reviewed yet.</div>`;
                }
            } else if (type === 'escalation') {
                const item = directEscalations.all.find(i => i.id.toString() === id);
                if(item) {
                    modalTitle.textContent = `Escalation: ${item.order_assignments?.orders?.order_id}`;
                    content = `<div class="detail-item"><strong>By:</strong><span>${item.escalated_by.name}</span></div><div class="detail-item"><strong>Reason:</strong><p>${item.notes}</p></div>`;
                }
            } else if (type === 'decision') {
                const item = finalizedDecisions.all.find(i => i.decision_id.toString() === id);
                if(item) {
                    modalTitle.textContent = `Decision: ${item.order_id}`;
                    content = `<div class="detail-item"><strong>Decision:</strong><span>${item.your_decision}</span></div><div class="detail-item"><strong>Notes:</strong><p>${item.decision_notes || 'None'}</p></div>`;
                }
            }
            modalBody.innerHTML = content;
            showModal('view-details-modal');
        }

        // Tab Management
        function restoreActiveTab() {
            const savedTab = localStorage.getItem('seniorActiveTab') || 'dashboard';
            document.querySelectorAll('.sidebar-nav li').forEach(li => li.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            const tabLink = document.querySelector(`a[data-tab="${savedTab}"]`);
            if (tabLink) {
                tabLink.parentElement.classList.add('active');
                document.getElementById(savedTab)?.classList.add('active');
                document.getElementById('page-title').textContent = tabLink.textContent.replace(/[\u{1F000}-\u{1FFFF}]/gu, '').trim();
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            
            document.querySelector('.sidebar-nav').addEventListener('click', e => {
                const link = e.target.closest('a[data-tab]');
                if (link) {
                    e.preventDefault();
                    localStorage.setItem('seniorActiveTab', link.dataset.tab);
                    restoreActiveTab();
                }
            });

            document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', () => hideModal(btn.dataset.modalId)));

            document.body.addEventListener('click', e => {
                if(e.target.matches('.view-btn')) openViewModal(e.target.dataset.type, e.target.dataset.id);
                if(e.target.matches('.decide-btn')) openDecisionModal(e.target.dataset.id);
                if(e.target.matches('.reassign-btn')) openReassignModal(e.target.dataset.id);
                if(e.target.matches('#logout-btn')) { e.preventDefault(); showModal('logout-confirm-modal'); }
                if(e.target.matches('#confirm-logout-btn')) { window.signOut().then(() => window.location.href = 'login.html'); }
            });
            
            // Filters and Pagination
            document.getElementById('assigned-search')?.addEventListener('input', () => applyFiltersAndRender('assigned'));
            document.getElementById('assigned-status-filter')?.addEventListener('change', () => applyFiltersAndRender('assigned'));
            document.getElementById('assigned-date-filter')?.addEventListener('input', () => applyFiltersAndRender('assigned'));
            document.getElementById('clear-assigned-filters-btn')?.addEventListener('click', () => {
                document.getElementById('assigned-search').value = '';
                document.getElementById('assigned-status-filter').value = 'all';
                document.getElementById('assigned-date-filter').value = '';
                applyFiltersAndRender('assigned');
            });

            const setupPagination = (containerId, dataObj, renderer) => {
                document.getElementById(containerId)?.addEventListener('click', e => {
                    const totalPages = Math.ceil(dataObj.filtered.length / ITEMS_PER_PAGE);
                    if(e.target.matches('.prev-btn') && dataObj.currentPage > 1) dataObj.currentPage--;
                    if(e.target.matches('.next-btn') && dataObj.currentPage < totalPages) dataObj.currentPage++;
                    renderer();
                });
            };
            setupPagination('assigned-orders-pagination', assignedOrders, renderAssignedOrdersTable);
            setupPagination('unassigned-orders-pagination', unassignedOrders, renderUnassignedOrdersTable);
            setupPagination('direct-escalations-pagination', directEscalations, renderDirectEscalationsTable);
            setupPagination('finalized-decisions-pagination', finalizedDecisions, renderFinalizedDecisionsTable);

            // CSV Downloads
            document.getElementById('assigned-orders-csv-btn')?.addEventListener('click', () => exportToCSV(['Order_ID', 'Agent', 'Status'], assignedOrders.filtered.map(a => ({ order_id: a.orders?.order_id, agent: a.users?.name, status: a.status })), 'assigned_orders.csv'));
            document.getElementById('unassigned-orders-csv-btn')?.addEventListener('click', () => exportToCSV(['Order_ID', 'Reason', 'Employee_Name'], unassignedOrders.filtered, 'unassigned_orders.csv'));
            document.getElementById('direct-escalations-csv-btn')?.addEventListener('click', () => exportToCSV(['Order_ID', 'Escalated_By', 'Status'], directEscalations.filtered.map(e => ({order_id: e.order_assignments?.orders?.order_id, escalated_by: e.escalated_by?.name, status: e.status})), 'direct_escalations.csv'));
            document.getElementById('finalized-decisions-csv-btn')?.addEventListener('click', () => exportToCSV(['Order_ID', 'Agent', 'Decision'], finalizedDecisions.filtered.map(d => ({order_id: d.order_id, agent: d.employee_username, decision: d.your_decision})), 'final_decisions.csv'));
        });
    })();
    </script>
</body>
</html>
